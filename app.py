# Paquetes utilizados
import streamlit as st
import pandas as pd
import numpy as np

## ESTABLECE CARACTER√çSTICAS GENERALES DEL SITIO
# Define t√≠tulo de la p√°gina
st.set_page_config(page_title="Visualizador CNED", layout="wide")

# Inserta el √≠cono del CNED en la parte superior derecha de la p√°gina
st.markdown(
    """
    <div style="text-align: right;">
        <img src="https://cned.cl/wp-content/uploads/2023/10/cned_s_fondo.png" width="100">
    </div>
    """,
    unsafe_allow_html=True
)

# Presentaci√≥n del visualizador
st.title("**VISUALIZADOR DE DATOS INSTITUCIONALES**")
st.subheader("√öltima actualizaci√≥n: 30 de septiembre de 2025")
st.markdown("Contacto: Fabi√°n Ram√≠rez (framirez@cned.cl)")

## CARGA LA BASE DE DATOS DE INFORMACI√ìN GENERAL
@st.cache_data
def load_data():
    try:
        # Intentar diferentes configuraciones para el CSV
        # Opci√≥n 1: UTF-8
        try:
            data = pd.read_csv('Listado IES.csv', encoding='utf-8')
            st.success("Archivo cargado con encoding UTF-8")
            return data
        except:
            # Opci√≥n 2: Latin-1 (com√∫n en archivos de Windows)
            try:
                data = pd.read_csv('Listado IES.csv', encoding='latin-1')
                st.success("Archivo cargado con encoding Latin-1")
                return data
            except:
                # Opci√≥n 3: Con par√°metros adicionales
                try:
                    data = pd.read_csv(
                        'Listado IES.csv', 
                        encoding='latin-1',
                        delimiter=',',
                        quotechar='"',
                        skipinitialspace=True,
                        engine='python',
                        on_bad_lines='skip'  # Saltar l√≠neas problem√°ticas
                    )
                    st.success("Archivo cargado con par√°metros extendidos")
                    return data
                except Exception as e:
                    st.error(f"No se pudo cargar el archivo: {str(e)}")
                    return pd.DataFrame()
    except Exception as e:
        st.error(f"Error inesperado: {str(e)}")
        return pd.DataFrame()

data = load_data()

# Verificar si se cargaron datos
if data.empty:
    st.error("No se pudieron cargar los datos. Verifica el archivo CSV.")
    st.stop()

# Mostrar informaci√≥n b√°sica del dataset
st.write(f"Dataset cargado: {len(data)} filas, {len(data.columns)} columnas")
st.write("Primeras filas del dataset:")
st.dataframe(data.head())

# Verificar que existe la columna 'ins_nom'
if 'ins_nom' not in data.columns:
    st.error("La columna 'ins_nom' no existe en el dataset. Columnas disponibles:")
    st.write(data.columns.tolist())
    st.stop()

# Obtener la lista de instituciones √∫nicas a partir de la columna 'ins_nom'
instituciones = data['ins_nom'].unique().tolist()

# Ordenar alfab√©ticamente
instituciones.sort()

# Sidebar para mejor organizaci√≥n
with st.sidebar:
    st.header("üè´ Selecci√≥n de Instituci√≥n")
    
    # Buscador
    buscar = st.text_input("Buscar instituci√≥n:", "")
    
    # Filtrar opciones si se usa el buscador
    if buscar:
        opciones_filtradas = [inst for inst in instituciones if buscar.lower() in inst.lower()]
        if opciones_filtradas:
            institucion_seleccionada = st.selectbox(
                "Resultados de b√∫squeda:",
                opciones_filtradas,
                key="selector_busqueda"
            )
        else:
            st.warning("No se encontraron instituciones con ese criterio.")
            institucion_seleccionada = st.selectbox(
                "Instituci√≥n:",
                instituciones,
                key="selector_institucion"
            )
    else:
        institucion_seleccionada = st.selectbox(
            "Instituci√≥n:",
            instituciones,
            key="selector_institucion"
        )

# Filtrar los datos para la instituci√≥n seleccionada
datos_institucion = data[data['ins_nom'] == institucion_seleccionada]

# Mostrar informaci√≥n de la instituci√≥n seleccionada
if not datos_institucion.empty:
    st.success(f"‚úÖ Instituci√≥n seleccionada: **{institucion_seleccionada}**")
    
    # Mostrar informaci√≥n b√°sica
    col1, col2, col3 = st.columns(3)
    
    with col1:
        if 'ins_cod' in datos_institucion.columns:
            st.metric("C√≥digo Instituci√≥n", datos_institucion['ins_cod'].iloc[0])
    
    with col2:
        if 'rec_nom' in datos_institucion.columns:
            st.metric("Rector/a", datos_institucion['rec_nom'].iloc[0])
    
    with col3:
        if 'pro_cned' in datos_institucion.columns:
            st.metric("Proceso CNED", datos_institucion['pro_cned'].iloc[0])
    
    # Mostrar informaci√≥n del directorio si existe
    if any(col.startswith('dir') for col in datos_institucion.columns):
        st.subheader("üë• Directorio")
        directores = []
        for i in range(1, 10):  # Para dir1 a dir9
            nom_col = f'dir{i}_nom'
            rol_col = f'dir{i}_rol'
            pro_col = f'dir{i}_pro'
            
            if (nom_col in datos_institucion.columns and 
                pd.notna(datos_institucion[nom_col].iloc[0])):
                directores.append({
                    'nombre': datos_institucion[nom_col].iloc[0],
                    'rol': datos_institucion[rol_col].iloc[0] if rol_col in datos_institucion.columns else 'N/A',
                    'profesion': datos_institucion[pro_col].iloc[0] if pro_col in datos_institucion.columns else 'N/A'
                })
        
        for director in directores:
            st.write(f"**{director['nombre']}** - {director['rol']} ({director['profesion']})")
else:
    st.warning("No se encontraron datos para la instituci√≥n seleccionada")
